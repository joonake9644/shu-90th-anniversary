<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Storage í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 {
            color: #fbbf24;
        }
        h2 {
            color: #fbbf24;
            border-bottom: 2px solid #fbbf24;
            padding-bottom: 10px;
        }
        button {
            background: #fbbf24;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #f59e0b;
        }
        #fileInput {
            margin: 10px 0;
        }
        .file-item {
            background: #1a1a1a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .file-item img {
            max-width: 200px;
            max-height: 200px;
            display: block;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #fbbf24;
        }
        .error {
            color: #ef4444;
            padding: 10px;
            background: #7f1d1d;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #10b981;
            padding: 10px;
            background: #064e3b;
            border-radius: 5px;
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #fbbf24;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #fbbf24;
        }
        .stat-label {
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Firebase Storage ì—°ë™ í…ŒìŠ¤íŠ¸</h1>

    <div class="container">
        <h2>ğŸ“Š Storage í†µê³„</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalFiles">0</div>
                <div class="stat-label">ì „ì²´ íŒŒì¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalImages">0</div>
                <div class="stat-label">ì´ë¯¸ì§€</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVideos">0</div>
                <div class="stat-label">ë¹„ë””ì˜¤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSize">0 MB</div>
                <div class="stat-label">ì „ì²´ í¬ê¸°</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h2>
        <input type="file" id="fileInput" accept="image/*,video/*">
        <button onclick="testUpload()">íŒŒì¼ ì—…ë¡œë“œ</button>
        <div id="uploadStatus"></div>
    </div>

    <div class="container">
        <h2>ğŸ“ Storage íŒŒì¼ ëª©ë¡</h2>
        <button onclick="loadFiles()">íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <div id="fileList" class="loading">ë¡œë”© ì¤‘...</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getStorage,
            ref,
            listAll,
            getDownloadURL,
            uploadBytes,
            deleteObject,
            getMetadata
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAFL2UzS-p_NAt3iGpI2V__S8g-B_72kZs",
            authDomain: "shu-90th-anniversary.firebaseapp.com",
            projectId: "shu-90th-anniversary",
            storageBucket: "shu-90th-anniversary.firebasestorage.app",
            messagingSenderId: "875713156990",
            appId: "1:875713156990:web:b8ad8badb7e2dbebedc52f"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        let allFiles = [];

        // íŒŒì¼ ëª©ë¡ ë¡œë“œ
        async function loadAllFiles() {
            const folders = ['uploads', 'periods', 'highlights', 'news', 'events', 'videos', 'history'];
            const files = [];
            let totalSize = 0;
            let imageCount = 0;
            let videoCount = 0;

            for (const folder of folders) {
                try {
                    const folderRef = ref(storage, folder);
                    const result = await listAll(folderRef);

                    for (const itemRef of result.items) {
                        try {
                            const url = await getDownloadURL(itemRef);
                            const metadata = await getMetadata(itemRef);

                            const fileInfo = {
                                name: itemRef.name,
                                url,
                                path: itemRef.fullPath,
                                size: metadata.size,
                                type: metadata.contentType || 'unknown',
                                uploadedAt: new Date(metadata.timeCreated),
                                ref: itemRef
                            };

                            files.push(fileInfo);
                            totalSize += metadata.size;

                            if (metadata.contentType?.startsWith('image/')) {
                                imageCount++;
                            } else if (metadata.contentType?.startsWith('video/')) {
                                videoCount++;
                            }
                        } catch (error) {
                            console.error(`Error loading ${itemRef.name}:`, error);
                        }
                    }
                } catch (error) {
                    console.log(`Folder ${folder} not found or empty`);
                }
            }

            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalFiles').textContent = files.length;
            document.getElementById('totalImages').textContent = imageCount;
            document.getElementById('totalVideos').textContent = videoCount;
            document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';

            return files.sort((a, b) => b.uploadedAt - a.uploadedAt);
        }

        // íŒŒì¼ ëª©ë¡ í‘œì‹œ
        window.loadFiles = async function() {
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '<div class="loading">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                allFiles = await loadAllFiles();

                if (allFiles.length === 0) {
                    fileListDiv.innerHTML = '<p>Storageì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                fileListDiv.innerHTML = allFiles.map(file => `
                    <div class="file-item">
                        <strong>ğŸ“„ ${file.name}</strong><br>
                        ê²½ë¡œ: ${file.path}<br>
                        í¬ê¸°: ${(file.size / 1024).toFixed(2)} KB<br>
                        íƒ€ì…: ${file.type}<br>
                        ì—…ë¡œë“œ: ${file.uploadedAt.toLocaleString('ko-KR')}<br>
                        ${file.type.startsWith('image/') ?
                            `<img src="${file.url}" alt="${file.name}">` : ''}
                        <br>
                        <button onclick="copyUrl('${file.url}')">URL ë³µì‚¬</button>
                        <button onclick="deleteFile('${file.path}')" style="background: #ef4444;">ì‚­ì œ</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading files:', error);
                fileListDiv.innerHTML = `<div class="error">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        };

        // íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
        window.testUpload = async function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('uploadStatus');

            if (!file) {
                statusDiv.innerHTML = '<div class="error">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            try {
                statusDiv.innerHTML = '<div class="loading">ì—…ë¡œë“œ ì¤‘...</div>';

                // íŒŒì¼ íƒ€ì…ì— ë”°ë¼ í´ë” ê²°ì •
                let folder = 'uploads';
                if (file.type.startsWith('video/')) {
                    folder = 'videos';
                }

                const timestamp = Date.now();
                const fileName = `${timestamp}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const storageRef = ref(storage, `${folder}/${fileName}`);

                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);

                statusDiv.innerHTML = `
                    <div class="success">
                        âœ… ì—…ë¡œë“œ ì„±ê³µ!<br>
                        íŒŒì¼ëª…: ${fileName}<br>
                        ê²½ë¡œ: ${folder}/${fileName}<br>
                        URL: <a href="${url}" target="_blank">${url}</a>
                    </div>
                `;

                // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadFiles();

                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                fileInput.value = '';
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.innerHTML = `<div class="error">ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        };

        // URL ë³µì‚¬
        window.copyUrl = function(url) {
            navigator.clipboard.writeText(url);
            alert('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        };

        // íŒŒì¼ ì‚­ì œ
        window.deleteFile = async function(path) {
            if (!confirm(`"${path}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const fileRef = ref(storage, path);
                await deleteObject(fileRef);
                alert('íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadFiles();
            } catch (error) {
                console.error('Delete error:', error);
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ ëª©ë¡ ë¡œë“œ
        loadFiles();
    </script>
</body>
</html>
